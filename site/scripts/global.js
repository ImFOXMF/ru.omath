(()=>{var l=class{onClick=()=>{};button;locked;lastY;constructor(e){this.button=e,this.lastY=scrollY,this.button.addEventListener("click",()=>this.onClick()),scrollY===0&&this.toggleShowing(!0),window.addEventListener("scroll",()=>{this.toggleShowing(scrollY===0||scrollY<this.lastY),this.lastY=scrollY}),window.addEventListener("resize",()=>this.toggleShowing(scrollY===0))}toggleLock(e){this.locked=e,e?this.toggleShowing(!1):this.toggleShowing(scrollY===0)}toggleShowing(e){e&&!this.locked?this.button.setAttribute("data-showing",""):this.button.removeAttribute("data-showing")}};var c=class{asides;openButtons;previewLock;constructor(){this.asides={},this.asides.major=document.querySelector("body > aside.major"),this.asides.minor=document.querySelector("body > aside.minor"),this.openButtons={},this.openButtons.major=new l(document.querySelector("body > main > .bottomSticky > .asideControls > .majorOpen")),this.openButtons.minor=new l(document.querySelector("body > main > .bottomSticky > .asideControls > .minorOpen")),this.openButtons.major.onClick=()=>this.toggleAside(this.asides.major,!0),this.openButtons.minor.onClick=()=>this.toggleAside(this.asides.minor,!0),document.querySelector("body > main").addEventListener("click",e=>{let t=e.composedPath();for(let i=0;i<t.length;i++)if(t[i]==this.openButtons.major.button||t[i]==this.openButtons.minor.button)return;(this.asides.major.hasAttribute("data-showing")||this.asides.minor.hasAttribute("data-showing"))&&this.hideAsides()});{let e=document.querySelector("#preview");e.addEventListener("screen",()=>{this.previewLock=!0,this.updateOpenButtons()}),e.addEventListener("close",()=>{this.previewLock=!1,this.updateOpenButtons()})}}updateOpenButtons(){let e=!1;this.asides.major.hasAttribute("data-showing")&&(e=!0),this.asides.minor.hasAttribute("data-showing")&&(e=!0),(document.querySelector("#preview").hasAttribute("style")||this.previewLock)&&(e=!0),this.openButtons.major.toggleLock(e),this.openButtons.minor.toggleLock(e)}toggleAside(e,t){t?e.setAttribute("data-showing",""):e.removeAttribute("data-showing"),this.updateOpenButtons()}hideAsides(){this.toggleAside(this.asides.major,!1),this.toggleAside(this.asides.minor,!1),this.updateOpenButtons()}};var h=class{asideMajor;constructor(e){this.asideMajor=document.querySelector("body > aside.major");let t=(i,n)=>{let o=i.getAttribute("data-target");i.addEventListener("click",()=>{this.switchTo(o),n&&e.toggleAside(this.asideMajor,!0)})};this.asideMajor.querySelectorAll(":scope > .full > .paneSwitcher > .inner > button").forEach(i=>{t(i,!1)}),this.asideMajor.querySelectorAll(":scope > .mini > button").forEach(i=>{t(i,!0)})}switchTo(e){this.asideMajor.setAttribute("data-pane",e)}};var u=class{panesManager;toggler;constructor(e){this.toggler=e,this.panesManager=new h(this.toggler)}};var d=class{viewContainer;views;bookTocs;bookTitles;constructor(e){this.viewContainer=e.asides.major.querySelector(':scope .pane[data-pane="toc"] .viewContainer'),this.views={},this.views.global=this.viewContainer.querySelector(':scope > .view[data-view="global"]'),this.views.loading=this.viewContainer.querySelector(':scope > .view[data-view="loading"]'),this.views.book=this.viewContainer.querySelector(':scope > .view[data-view="book"]'),this.setupBookClickLogic(),this.views.book.querySelector(":scope .controls > .navButtons > .back").addEventListener("click",()=>this.setView(this.views.global));let t=this.views.book.querySelector(".bookToc");if(t){let i=t.getAttribute("data-book-id");this.initBookToc(i,document.documentElement.getAttribute("data-topic")),this.bookTocs[i]=t}}setupBookClickLogic(){this.bookTocs={},this.views.global.querySelectorAll(".tocItem > a").forEach(e=>{let t=e.closest(".tocItem").getAttribute("data-id");e.addEventListener("click",()=>{t in this.bookTocs?(this.setCurrentBookToc(t),this.setView(this.views.book)):(this.setView(this.views.loading),fetch("/site/book-tocs/"+t+".html").then(i=>i.text()).then(i=>{this.views.book.querySelector(":scope > .inner").insertAdjacentHTML("beforeend",i),this.bookTocs[t]=this.views.book.querySelector(`.bookToc[data-book-id="${t}"]`),this.initBookToc(t),this.setCurrentBookToc(t),this.setView(this.views.book)}))})})}setCurrentBookToc(e){Object.values(this.bookTocs).forEach(t=>t.removeAttribute("data-current")),this.bookTocs[e].setAttribute("data-current",""),this.views.book.querySelector(".bookTitle").innerHTML=this.views.global.querySelector(`.tocItem[data-id="${e}"] > a > .label`).innerHTML,this.views.book.querySelector(".controls > .navButtons > .home").setAttribute("href",`/book/${e}`)}setView(e){this.viewContainer.setAttribute("data-view",e.getAttribute("data-view"))}initBookToc(e,t=null){let i=this.views.book.querySelector(`.bookToc[data-book-id="${e}"]`);if(i.querySelectorAll(".tocSection > .tocItem > a").forEach(n=>n.addEventListener("click",function(){this.closest(".tocSection").toggleAttribute("data-open")})),t){let n=i.querySelector(`.tocItem[data-id="${t}"]`);if(n){n.setAttribute("data-current","");let o=n;for(;o!=null;)o.classList.contains("tocItem")&&o.setAttribute("data-accent",""),o.classList.contains("tocSection")&&(o.setAttribute("data-open",""),o.querySelector(":scope > .tocItem").setAttribute("data-accent","")),o=o.parentElement}}}};function T(){let s=getComputedStyle(document.documentElement);return parseFloat(s.getPropertyValue("--transitionSpeed"))*1e3}var m=class{element;onClick;constructor(e){this.element=e,this.element.addEventListener("click",()=>this.onClick&&this.canClick()&&this.onClick())}canClick(){return!0}},v=class extends m{title;constructor(e){super(e),this.title=this.element.getAttribute("title")}setDisabled(e){this.element.classList.toggle("disabled",e),e?this.element.removeAttribute("title"):this.element.setAttribute("title",this.title)}canClick(){return!this.element.classList.contains("disabled")}},f=class extends v{},S=class extends v{setSource(e){this.setDisabled(!e),this.element.setAttribute("href",e||"")}};var k=class extends m{setState(e){this.element.dataset.state=e,this.element.setAttribute("title",this.element.getAttribute(`data-label-${e}`))}},y=class extends m{};var a=class{id;element;inner;onHeightChange;observer;constructor(e,t){this.id=e;let i;if(typeof t=="string"){let n=document.createElement("div");n.className="screen";let o=document.createElement("div");o.className="inner",o.setAttribute("data-content",""),o.innerHTML=t,n.appendChild(o),i=n}else i=t;this.element=i,this.inner=this.element.querySelector(":scope > .inner"),this.observer=new ResizeObserver(()=>this.onHeightChange&&this.onHeightChange(this.getHeight()))}setCurrent(e){e?(this.element.setAttribute("data-current",""),this.observer.observe(this.inner)):(this.element.removeAttribute("data-current"),this.observer.unobserve(this.inner))}getHeight(){return this.inner.offsetHeight+1}};function C(){return{vendor:{photoSwipe:PhotoSwipeLang}}}var g=class{onBackClick;onCloseComplete;elements;heights;buttons;animSpeed;closed;collapsed;screen;screens={};stateScreens;constructor(){{this.elements={},this.elements.preview=document.querySelector("#preview"),this.elements.display=this.elements.preview.querySelector(":scope > .display");let e=new Event("closed");this.elements.preview.dispatchEvent(e)}{let e=getComputedStyle(this.elements.preview);this.heights={},this.heights.maxPreview=parseInt(e.getPropertyValue("--maxHeight")),this.heights.footer=parseInt(e.getPropertyValue("--footerHeight"))}{let e=document.querySelector("#preview > footer > .controls");this.buttons={},this.buttons.back=new f(e.querySelector(".back")),this.buttons.goto=new S(e.querySelector(".goto")),this.buttons.mini=new k(e.querySelector(".mini")),this.buttons.exit=new y(e.querySelector(".exit"))}{this.buttons.mini.setState("collapse"),this.buttons.back.onClick=()=>this.onBackClick&&this.onBackClick(),this.buttons.mini.onClick=()=>{this.closed||this.setCollapsed(!this.collapsed)};{let e;this.buttons.exit.onClick=()=>{clearTimeout(e),this.closed=!0,this.screen&&this.screen.setCurrent(!1),this.elements.preview.removeAttribute("style"),e=setTimeout(()=>{!this.closed||(this.clearScreen(),this.setButtons(!1,null),this.setCollapsed(!1),this.onCloseComplete&&this.onCloseComplete(),this.elements.preview.dispatchEvent(new Event("close")))},this.animSpeed)}}}this.animSpeed=T(),this.stateScreens={},this.stateScreens.loading=new a("loading",this.elements.display.querySelector(":scope > .loading")),this.stateScreens.error=new a("error",this.elements.display.querySelector(":scope > .error"))}getClosed(){return this.closed}setButtons(e,t){this.buttons.back.setDisabled(!e),this.buttons.goto.setSource(t)}exit(){this.buttons.exit.element.click()}setViewScreen(e){this.setScreen(this.screens[e.url]||new a(e.url,e.content))}setLoadingScreen(){this.setStateScreen("loading")}setErrorScreen(){this.setStateScreen("error")}setStateScreen(e){let t=150;this.screen&&(t=Math.max(t,this.elements.display.clientHeight));let i=this.stateScreens[e];i.inner.setAttribute("style","height: "+t+"px;"),this.setScreen(i)}setScreen(e){if(this.elements.preview.dispatchEvent(new Event("screen")),this.closed=!1,this.setCollapsed(!1),this.screen){if(e.id===this.screen.id){this.screen.setCurrent(!0);return}this.screen.setCurrent(!1)}e.id in this.screens||(this.screens[e.id]=e,this.elements.display.appendChild(e.element),OMathContent.initProducts(e.element,C()),e.onHeightChange=t=>!this.collapsed&&this.setHeight(t)),this.screen=this.screens[e.id],setTimeout(()=>this.screen.setCurrent(!0),0),this.setHeight(this.screen.getHeight())}clearScreen(){this.screen&&(this.screen.setCurrent(!1),this.screen=null),Object.values(this.screens).forEach(e=>{e==this.stateScreens.loading||e==this.stateScreens.error||this.elements.display.removeChild(e.element)}),this.screens={...this.stateScreens}}setHeight(e,t=!1){t||(e+=this.heights.footer),e=Math.min(e,this.heights.maxPreview),this.elements.preview.setAttribute("style","height: "+e+"px;")}setCollapsed(e){this.collapsed=e,e?(this.setHeight(50,!0),this.buttons.mini.setState("expand")):(this.screen&&(this.closed||this.setHeight(this.screen.getHeight())),this.buttons.mini.setState("collapse"))}};var p=class{url;source;content;static isValid(e){return!(!("source"in e)||!("content"in e))}};var b=class{onLoad;onError;currentUrl;cache={};pendingUrls={};load(e,t){if(e===this.currentUrl)return;if(e in this.cache){let n=this.cache[e];n===null?this.onError(e):this.onLoad(n);return}if(this.currentUrl=e,this.pendingUrls[e])return;this.pendingUrls[e]=!0;let i;fetch(e).then(n=>n.text()).then(n=>{let o=new p;o.url=e,o.source=t,o.content=n,this.cache[e]=o,i=()=>this.onLoad(o)}).catch(()=>{this.cache[e]=null,i=()=>this.onError(e)}).finally(()=>{delete this.pendingUrls[e],e===this.currentUrl&&(i(),this.currentUrl=null)})}};var w=class{ui;loader;viewStack=[];loading;constructor(){this.ui=new g,this.ui.onBackClick=()=>{let e;for(let t=0;t<(this.loading?1:2);t++)e=this.viewStack.pop();e&&this.showView(e)},this.ui.onCloseComplete=()=>{this.loading=!1,this.viewStack=[]};{this.loader=new b;let e=()=>this.loading;this.loader.onLoad=t=>{!e()||this.showView(t)},this.loader.onError=()=>{!e()||this.showError()}}}exit(){this.ui.exit()}loadView(e,t){if(this.viewStack[this.viewStack.length-1]?.url===e){this.exit();return}this.showLoading(),this.loader.load(e,t)}showView(e){this.loading=!1,this.viewStack.at(-1)!=e&&this.viewStack.push(e),this.ui.setViewScreen(e),this.ui.setButtons(this.canBack(),L(e.source)?null:e.source)}showLoading(){this.loading||(this.loading=!0,this.ui.setLoadingScreen(),this.ui.setButtons(this.canBack(),null))}showError(){this.ui.setErrorScreen(),this.ui.setButtons(this.canBack(),null)}canBack(){let e=this.loading?1:2;return this.viewStack.length>=e}};function L(s){let e=location.host+location.pathname,t=location.host+s.split("/").slice(0,-1).join("/")+"/";return e===t}var r=class{preview;asideToggler;static get(){return window.OMath}};function E(){function s(){document.querySelectorAll(".noDarkMagicContainer").forEach(e=>e.parentElement.removeAttribute("id"))}fetch("https://yandex.ru/ads/system/context.js").then(e=>{e.ok||s()}).catch(()=>s())}window.OMath=new r;window.addEventListener("DOMContentLoaded",()=>{r.get().preview=new w,r.get().asideToggler=new c,new u(r.get().asideToggler),new d(r.get().asideToggler),globalThis.OMathContentOptions=C(),OMathContent.initProducts(document.querySelector("body > main > article > [data-content]"),globalThis.OMathContentOptions),E()});globalThis.OMathEvent=globalThis.OMathEvent||{};globalThis.OMathEvent.onLinkClick=(s,e)=>{let t=s.getAttribute("data-preview").replace(/[\|:]/gm,"/");t="/site/uniques/"+t+".html",r.get().preview.loadView(t,s.getAttribute("href"))};})();
